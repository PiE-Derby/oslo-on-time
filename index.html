<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Oslo Transport ‚Äî I Rute?</title>
  <meta name="description" content="Er kollektivtrafikken i Oslo i rute? Interaktivt kart og statistikk, oppdatert hvert 15. minutt.">
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@600;700;800&family=Inter:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg:     #111318;
      --bg2:    #1a1d25;
      --bg3:    #20242e;
      --border: rgba(255,255,255,0.07);
      --text:   #f0f2f5;
      --muted:  #8090a8;
      --cyan:   #0cb6eb;
      --green:  #22c55e;
      --amber:  #f59e0b;
      --red:    #f05050;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    .skip-nav { position:absolute; left:-999px; width:1px; height:1px; overflow:hidden; }
    .skip-nav:focus { position:fixed; left:1rem; top:1rem; width:auto; height:auto; background:var(--cyan); color:#000; padding:.5rem 1rem; border-radius:6px; z-index:9999; font-weight:600; }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg); color: var(--text);
      min-height: 100vh; -webkit-font-smoothing: antialiased;
    }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    .header {
      position: sticky; top: 0; z-index: 500;
      background: rgba(17,19,24,0.92);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 1.25rem;
      display: flex; align-items: center; justify-content: space-between; gap: 1rem; flex-wrap: wrap;
    }
    .logo { display: flex; align-items: center; gap: 0.7rem; }
    .logo svg { flex-shrink: 0; }
    .logo-text h1 { font-family:'Urbanist',sans-serif; font-size:1.1rem; font-weight:800; letter-spacing:-.03em; color:#fff; line-height:1; }
    .logo-text h1 span { color:var(--cyan); }
    .logo-text p { font-size:0.7rem; color:var(--muted); margin-top:.15rem; }
    .header-right { display:flex; align-items:center; gap:.75rem; flex-wrap:wrap; }

    .live-badge {
      display:flex; align-items:center; gap:.35rem;
      font-family:inherit; font-size:.72rem; font-weight:500; color:var(--green);
      background:rgba(34,197,94,.08); border:1px solid rgba(34,197,94,.2);
      padding:.28rem .65rem; border-radius:999px; cursor:pointer;
      transition:all .2s; white-space:nowrap;
    }
    .live-badge:focus-visible { outline:2px solid var(--cyan); outline-offset:2px; }
    .live-badge.paused { color:var(--muted); background:rgba(128,144,168,.08); border-color:rgba(128,144,168,.2); }
    .live-badge .dot { width:6px; height:6px; border-radius:50%; background:var(--green); animation:pulse 2s infinite; flex-shrink:0; }
    .live-badge.paused .dot { background:var(--muted); animation:none; }
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

    /* ‚îÄ‚îÄ MAP ‚îÄ‚îÄ */
    #map {
      height: 420px;
      width: 100%;
      border-bottom: 1px solid var(--border);
      z-index: 1;
    }
    .leaflet-popup-content-wrapper {
      background: #1a1d25 !important;
      border: 1px solid rgba(255,255,255,.1) !important;
      border-radius: 10px !important;
      box-shadow: 0 8px 32px rgba(0,0,0,.5) !important;
      color: #f0f2f5 !important;
    }
    .leaflet-popup-tip { background: #1a1d25 !important; }
    .leaflet-popup-content { margin: 10px 14px !important; font-family:'Inter',sans-serif; }
    .popup-name { font-family:'Urbanist',sans-serif; font-size:1rem; font-weight:700; }
    .popup-area { font-size:.72rem; color:#8090a8; margin-bottom:.5rem; }
    .popup-pct  { font-family:'Urbanist',sans-serif; font-size:2rem; font-weight:800; line-height:1; }
    .popup-meta { font-size:.75rem; color:#8090a8; margin-top:.2rem; }

    /* ‚îÄ‚îÄ CONTENT ‚îÄ‚îÄ */
    .content { max-width: 900px; margin: 0 auto; padding: 1.5rem 1.25rem 4rem; }

    /* ‚îÄ‚îÄ SCORE BAR ‚îÄ‚îÄ */
    .score-bar {
      display: flex; align-items: center; gap: 1.5rem;
      background: var(--bg2); border: 1px solid var(--border);
      border-radius: 14px; padding: 1.25rem 1.5rem;
      margin-bottom: 1rem; position: relative; overflow: hidden;
    }
    .score-bar::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; background:linear-gradient(90deg,transparent,var(--cyan),transparent); }
    .big-num { font-family:'Urbanist',sans-serif; font-size:4.5rem; font-weight:800; letter-spacing:-.05em; line-height:1; transition:color .4s; }
    .big-num.good{color:var(--green)} .big-num.ok{color:var(--amber)} .big-num.bad{color:var(--red)}
    .score-info { flex:1; }
    .verdict { font-family:'Urbanist',sans-serif; font-size:1.2rem; font-weight:700; color:#fff; letter-spacing:-.02em; }
    .score-desc { font-size:.8rem; color:var(--muted); margin-top:.3rem; line-height:1.6; }
    .score-desc strong { color:#c9d4e0; }

    /* ‚îÄ‚îÄ AREA FILTERS ‚îÄ‚îÄ */
    .section-label { font-size:.68rem; font-weight:600; text-transform:uppercase; letter-spacing:.1em; color:var(--muted); margin-bottom:.6rem; margin-top:1.25rem; }

    .area-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: .5rem; margin-bottom: 1.25rem;
    }
    .area-btn {
      font-family: inherit; cursor: pointer;
      background: var(--bg2); border: 1px solid var(--border);
      border-radius: 10px; padding: .7rem .9rem;
      text-align: left; transition: all .15s;
      display: flex; flex-direction: column; gap: .2rem;
    }
    .area-btn:hover { border-color:rgba(12,182,235,.3); }
    .area-btn:focus-visible { outline:2px solid var(--cyan); outline-offset:2px; }
    .area-btn.active { background:rgba(12,182,235,.1); border-color:rgba(12,182,235,.4); }
    .area-btn .area-name { font-size:.82rem; font-weight:600; color:var(--text); }
    .area-btn .area-pct  { font-family:'Urbanist',sans-serif; font-size:1.4rem; font-weight:800; line-height:1; }
    .area-btn .area-sub  { font-size:.68rem; color:var(--muted); }

    /* ‚îÄ‚îÄ STAT ROW ‚îÄ‚îÄ */
    .stat-row { display:grid; grid-template-columns:repeat(3,1fr); gap:.75rem; margin-bottom:1rem; }
    .stat { background:var(--bg2); border:1px solid var(--border); border-radius:12px; padding:.9rem 1rem; text-align:center; }
    .stat .val { font-family:'Urbanist',sans-serif; font-size:1.9rem; font-weight:800; letter-spacing:-.04em; line-height:1; }
    .stat .lbl { font-size:.68rem; color:var(--muted); margin-top:.25rem; font-weight:500; text-transform:uppercase; letter-spacing:.05em; }
    .stat .sub { font-size:.68rem; color:var(--muted); margin-top:.15rem; opacity:.7; }
    .stat.green .val{color:var(--green)} .stat.amber .val{color:var(--amber)} .stat.red .val{color:var(--red)}

    /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
    .card { background:var(--bg2); border:1px solid var(--border); border-radius:12px; padding:1.1rem 1.4rem; margin-bottom:1rem; }
    .card h2 { font-size:.68rem; font-weight:600; text-transform:uppercase; letter-spacing:.1em; color:var(--muted); margin-bottom:1rem; }
    .chart-wrap { position:relative; height:150px; }

    /* Mode bars */
    .mode-list { display:flex; flex-direction:column; gap:.8rem; }
    .mode-row  { display:flex; align-items:center; gap:.8rem; }
    .mode-icon { font-size:.95rem; width:20px; text-align:center; flex-shrink:0; }
    .mode-name { font-size:.82rem; font-weight:500; width:70px; flex-shrink:0; }
    .mode-bg   { flex:1; height:5px; background:rgba(255,255,255,.06); border-radius:3px; overflow:hidden; }
    .mode-fill { height:100%; border-radius:3px; transition:width .5s; }
    .mode-pct  { font-size:.8rem; font-weight:600; width:36px; text-align:right; }
    .mode-cnt  { font-size:.7rem; color:var(--muted); width:60px; text-align:right; }

    /* Skamtavle */
    .shame-grid { display:grid; grid-template-columns:1fr 1fr; gap:.65rem; }
    .shame-item { background:var(--bg3); border:1px solid var(--border); border-radius:10px; padding:.8rem .9rem; }
    .shame-lbl  { font-size:.66rem; color:var(--muted); text-transform:uppercase; letter-spacing:.06em; font-weight:500; }
    .shame-val  { font-family:'Urbanist',sans-serif; font-size:1.1rem; font-weight:700; color:#fff; margin-top:.2rem; }
    .shame-sub  { font-size:.7rem; color:var(--muted); margin-top:.08rem; }

    .footer { text-align:center; margin-top:2rem; font-size:.72rem; color:var(--muted); opacity:.45; }
    .footer a { color:var(--muted); text-underline-offset:2px; }
    .footer a:focus-visible { outline:2px solid var(--cyan); outline-offset:2px; border-radius:2px; }

    /* ‚îÄ‚îÄ TREND ARROW ‚îÄ‚îÄ */
    .trend {
      display: inline-flex; align-items: center; gap: .3rem;
      font-family: 'Urbanist', sans-serif; font-size: .82rem; font-weight: 700;
      padding: .18rem .5rem; border-radius: 6px;
    }
    .trend.up   { color: var(--green); background: rgba(34,197,94,.12); }
    .trend.down { color: var(--red);   background: rgba(240,80,80,.12); }
    .trend.flat { color: var(--muted); background: rgba(128,144,168,.1); }

    /* ‚îÄ‚îÄ RUSHTID ‚îÄ‚îÄ */
    .rush-badge {
      display: none; align-items: center; gap: .35rem;
      font-family: inherit; font-size: .72rem; font-weight: 600;
      color: #fff; background: rgba(240,80,80,.2);
      border: 1px solid rgba(240,80,80,.4);
      padding: .28rem .7rem; border-radius: 999px; white-space: nowrap;
    }
    .rush-badge.visible { display: flex; }

    /* ‚îÄ‚îÄ AREA RANKING ‚îÄ‚îÄ */
    .area-rank-list { display: flex; flex-direction: column; gap: .55rem; }
    .area-rank-row {
      display: flex; align-items: center; gap: .75rem;
      cursor: pointer; padding: .45rem .6rem; border-radius: 8px;
      border: 1px solid transparent; transition: all .15s;
    }
    .area-rank-row:hover { background: rgba(255,255,255,.03); border-color: rgba(12,182,235,.2); }
    .area-rank-row:focus-visible { outline: 2px solid var(--cyan); outline-offset: 2px; }
    .area-rank-row.active { background: rgba(12,182,235,.08); border-color: rgba(12,182,235,.3); }
    .rank-num  { font-size: .72rem; color: var(--muted); width: 16px; text-align: center; flex-shrink: 0; }
    .rank-name { font-size: .82rem; font-weight: 500; width: 130px; flex-shrink: 0; }
    .rank-bg   { flex: 1; height: 6px; background: rgba(255,255,255,.05); border-radius: 3px; overflow: hidden; }
    .rank-fill { height: 100%; border-radius: 3px; transition: width .6s; }
    .rank-pct  { font-size: .82rem; font-weight: 700; width: 38px; text-align: right; }

    /* Transport filters */
    .mode-filters { display:flex; gap:.4rem; flex-wrap:wrap; margin-bottom:1.25rem; }
    .mode-btn {
      display:flex; align-items:center; gap:.3rem; font-family:inherit;
      font-size:.75rem; font-weight:500; padding:.3rem .75rem; border-radius:999px;
      border:1px solid var(--border); background:var(--bg2); color:var(--muted);
      cursor:pointer; transition:all .15s; white-space:nowrap;
    }
    .mode-btn:hover { border-color:rgba(12,182,235,.3); color:var(--text); }
    .mode-btn:focus-visible { outline:2px solid var(--cyan); outline-offset:2px; }
    .mode-btn.active { background:rgba(12,182,235,.12); border-color:rgba(12,182,235,.4); color:var(--cyan); }

    @media(max-width:550px) {
      .score-bar { flex-direction:column; gap:.75rem; }
      .big-num { font-size:3.5rem; }
      .stat-row { grid-template-columns:repeat(3,1fr); }
      .shame-grid { grid-template-columns:1fr; }
      #map { height:300px; }
    }
  </style>
</head>
<body>
<a href="#main" class="skip-nav">Hopp til innhold</a>

<!-- HEADER -->
<header class="header">
  <div class="logo">
    <svg width="36" height="36" viewBox="0 0 64 64" role="img" aria-label="Oslo Transport logo" xmlns="http://www.w3.org/2000/svg">
      <rect width="64" height="64" rx="14" fill="#1a1d25"/>
      <rect x="8" y="22" width="48" height="22" rx="6" fill="#0cb6eb"/>
      <path d="M44 22 Q56 22 56 30 L56 44 L44 44 Z" fill="#0997c5"/>
      <rect x="13" y="27" width="9" height="8" rx="2" fill="#111318" opacity=".8"/>
      <rect x="27" y="27" width="9" height="8" rx="2" fill="#111318" opacity=".8"/>
      <rect x="41" y="27" width="9" height="8" rx="2.5" fill="#111318" opacity=".6"/>
      <circle cx="18" cy="47" r="5" fill="#111318" stroke="#0cb6eb" stroke-width="2"/>
      <circle cx="18" cy="47" r="2" fill="#0cb6eb"/>
      <circle cx="46" cy="47" r="5" fill="#111318" stroke="#0cb6eb" stroke-width="2"/>
      <circle cx="46" cy="47" r="2" fill="#0cb6eb"/>
      <rect x="4" y="52" width="56" height="2.5" rx="1.25" fill="#2a3040"/>
      <circle cx="50" cy="14" r="11" fill="#111318" stroke="#22c55e" stroke-width="2"/>
      <circle cx="50" cy="14" r="1.5" fill="#22c55e"/>
      <line x1="50" y1="14" x2="50" y2="7" stroke="#22c55e" stroke-width="2" stroke-linecap="round"/>
      <line x1="50" y1="14" x2="55" y2="14" stroke="#22c55e" stroke-width="1.5" stroke-linecap="round"/>
    </svg>
    <div class="logo-text">
      <h1>Oslo Transport ‚Äî <span>I Rute?</span></h1>
      <p>26 stoppesteder ¬∑ 10 bydeler ¬∑ oppdateres hvert 15. min</p>
    </div>
  </div>
  <div class="header-right">
    <div class="rush-badge" id="rush-badge" role="status" aria-live="polite">
      üö® <span id="rush-label">Rushtid n√•</span>
    </div>
    <button class="live-badge" id="refresh-badge" onclick="togglePause()"
            aria-label="Auto-oppdatering. Klikk for √• pause eller gjenoppta." aria-pressed="false">
      <div class="dot" aria-hidden="true"></div>
      <span id="refresh-label">Laster‚Ä¶</span>
    </button>
  </div>
</header>

<!-- MAP -->
<div id="map" role="img" aria-label="Kart over Oslo som viser punktlighet per stoppested"></div>

<main id="main" class="content">

  <!-- SCORE BAR -->
  <div class="score-bar" id="score-bar">
    <div class="big-num ok" id="big-num">‚Äì%</div>
    <div class="score-info">
      <p class="verdict" id="verdict">Laster‚Ä¶</p>
      <p id="trend-line" style="margin-top:.3rem;min-height:1.4rem;"></p>
      <p class="score-desc" id="score-desc" style="margin-top:.2rem;"></p>
    </div>
  </div>

  <!-- TRANSPORT FILTERS -->
  <p class="section-label">Transportmiddel</p>
  <div class="mode-filters" role="group" aria-label="Filtrer p√• transportmiddel">
    <button class="mode-btn active" type="button" data-mode="all"   aria-pressed="true"  onclick="setMode('all')">üö¶ Alle</button>
    <button class="mode-btn"        type="button" data-mode="rail"  aria-pressed="false" onclick="setMode('rail')">üöÜ Tog</button>
    <button class="mode-btn"        type="button" data-mode="metro" aria-pressed="false" onclick="setMode('metro')">üöá T-bane</button>
    <button class="mode-btn"        type="button" data-mode="tram"  aria-pressed="false" onclick="setMode('tram')">üöä Trikk</button>
    <button class="mode-btn"        type="button" data-mode="bus"   aria-pressed="false" onclick="setMode('bus')">üöå Buss</button>
  </div>

  <!-- AREA FILTERS -->
  <p class="section-label">Bydel</p>
  <div class="area-grid" id="area-grid" role="group" aria-label="Filtrer p√• bydel"></div>

  <!-- STATS -->
  <div id="stats"></div>

</main>

<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let db = null;
let activeMode = 'all';
let activeArea = 'all';
let mapObj = null;
let markers = {};
let chartObj = null;

// ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MODES_NO = { rail:'Tog', metro:'T-bane', tram:'Trikk', bus:'Buss', water:'Ferge', unknown:'Annet' };
const MODE_ICON = { rail:'üöÜ', metro:'üöá', tram:'üöä', bus:'üöå', water:'‚õ¥Ô∏è', unknown:'üöê' };

const VERDICTS = [
  [90, 'G√•r som smurt üü¢', 'good'],
  [78, 'Stort sett i rute', 'ok'],
  [65, 'Noen forsinkelser', 'ok'],
  [50, 'Ganske kaotisk üî¥', 'bad'],
  [0,  'Total kaos üö®',     'bad'],
];

function pct(v,t) { return t>0 ? Math.round(v/t*100) : 0; }
function barColor(p) { return p>=80?'#22c55e':p>=60?'#f59e0b':'#f05050'; }
function fmtTime(ts) { return new Date(ts*1000).toLocaleTimeString('no-NO',{hour:'2-digit',minute:'2-digit'}); }
function hourOf(ts)  { return new Date(ts*1000).getHours(); }

// Oslo time: UTC+1 (UTC+2 summer ‚Äî simplified, close enough)
function osloHour() {
  const d = new Date();
  const oslo = new Date(d.toLocaleString('en-US', { timeZone: 'Europe/Oslo' }));
  return oslo.getHours();
}

function isRushHour() {
  const h = osloHour();
  return (h >= 7 && h < 9) || (h >= 15 && h < 18);
}

function rushLabel() {
  const h = osloHour();
  if (h >= 7  && h < 9)  return 'üö® Morgenrush (07‚Äì09)';
  if (h >= 15 && h < 18) return 'üö® Ettermiddagsrush (15‚Äì18)';
  return '';
}

// Trend: compare last ~30min avg vs 60‚Äì90min ago
function calcTrend(history, mode, area) {
  const now = Date.now() / 1000;
  const recent = history.filter(h => h.t >= now - 1800); // last 30min
  const before = history.filter(h => h.t >= now - 5400 && h.t < now - 1800); // 30‚Äì90min ago
  if (!recent.length || !before.length) return null;

  const avg = arr => {
    const t = arr.reduce((a,h)=>{ const s=slicePoint(h,mode,area); return s?{tot:a.tot+s.total,on:a.on+s.onTime}:a; }, {tot:0,on:0});
    return t.tot > 0 ? pct(t.on, t.tot) : null;
  };

  const r = avg(recent), b = avg(before);
  if (r === null || b === null) return null;
  const diff = r - b;
  if (diff > 3)  return { dir:'up',   diff, label: `+${diff}pp`, html: `‚ñ≤ +${diff}pp` };
  if (diff < -3) return { dir:'down', diff, label: `${diff}pp`,  html: `‚ñº ${diff}pp` };
  return { dir:'flat', diff: 0, label: '‚Üí stabilt', html: '‚Üí stabilt' };
}

// Aggregate lines across history samples
function aggregateLines(history) {
  const lines = {};
  for (const h of history) {
    for (const [lk, v] of Object.entries(h.lines || {})) {
      if (!lines[lk]) lines[lk] = { mode:v.mode, name:v.name, total:0, onTime:0, delayed:0, cancelled:0 };
      lines[lk].total     += v.total;
      lines[lk].onTime    += v.onTime;
      lines[lk].delayed   += v.delayed   || 0;
      lines[lk].cancelled += v.cancelled || 0;
    }
  }
  return lines;
}

// ‚îÄ‚îÄ MAP INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initMap() {
  mapObj = L.map('map', { zoomControl: true, attributionControl: true }).setView([59.92, 10.76], 12);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
    subdomains: 'abcd', maxZoom: 19
  }).addTo(mapObj);
}

function updateMap(lastPoint, stops) {
  if (!mapObj || !lastPoint || !stops) return;
  const stopStats = lastPoint.stops || {};

  for (const [id, info] of Object.entries(stops)) {
    const s = stopStats[id];
    const p = s ? pct(s.onTime, s.total) : null;
    const color = p === null ? '#4b5563' : barColor(p);
    const radius = s ? Math.max(8, Math.min(18, 8 + s.total/4)) : 7;

    const circle = L.circleMarker([info.lat, info.lon], {
      radius, color, fillColor: color, fillOpacity: 0.85,
      weight: 2, opacity: 1
    });

    const label = p !== null
      ? `<div class="popup-name">${info.name}</div>
         <div class="popup-area">${info.area}</div>
         <div class="popup-pct" style="color:${color}">${p}%</div>
         <div class="popup-meta">i rute akkurat n√•<br>${s.delayed} forsinket ¬∑ ${s.cancelled} innstilt ¬∑ ${s.total} avg.</div>`
      : `<div class="popup-name">${info.name}</div><div class="popup-area">${info.area}</div><div class="popup-meta">Ingen data</div>`;

    circle.bindPopup(label, { maxWidth: 200 });
    circle.on('click', () => setArea(info.area));

    if (markers[id]) { markers[id].circle.remove(); }
    markers[id] = { circle, area: info.area, lat: info.lat, lon: info.lon, baseColor: color, baseRadius: radius };
    circle.addTo(mapObj);
  }
}

// ‚îÄ‚îÄ MAP AREA FILTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function filterMapByArea(area) {
  if (!mapObj) return;
  const bounds = [];

  for (const [, m] of Object.entries(markers)) {
    const inArea = area === 'all' || m.area === area;
    m.circle.setStyle({
      fillOpacity: inArea ? 0.85 : 0.12,
      opacity:     inArea ? 1    : 0.2,
      weight:      inArea ? 2    : 1,
    });
    m.circle.setRadius(inArea ? m.baseRadius : Math.max(5, m.baseRadius * 0.7));
    if (inArea) bounds.push([m.lat, m.lon]);
  }

  if (area === 'all') {
    mapObj.flyTo([59.92, 10.76], 12, { animate: true, duration: 0.6 });
  } else if (bounds.length) {
    mapObj.flyToBounds(bounds, { padding: [60, 60], maxZoom: 14, animate: true, duration: 0.7 });
  }
}

// ‚îÄ‚îÄ SLICING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function slicePoint(point, mode, area) {
  const stops = db?.stops || {};
  // Filter stops by area
  const areaStopIds = area === 'all' ? null : Object.entries(stops).filter(([,s])=>s.area===area).map(([id])=>id);

  if (mode === 'all' && area === 'all') {
    return { total:point.total, onTime:point.onTime, delayed:point.delayed, cancelled:point.cancelled };
  }

  if (mode !== 'all' && area === 'all') {
    const m = (point.modes||{})[mode];
    return m ? { total:m.total, onTime:m.onTime, delayed:m.delayed||0, cancelled:m.cancelled||0 } : null;
  }

  // Area filter ‚Äî aggregate from stop-level data
  const stopStats = point.stops || {};
  let total=0, onTime=0, delayed=0, cancelled=0;
  for (const sid of (areaStopIds||[])) {
    const s = stopStats[sid];
    if (!s) continue;
    total+=s.total; onTime+=s.onTime; delayed+=s.delayed||0; cancelled+=s.cancelled||0;
  }
  return total > 0 ? { total, onTime, delayed, cancelled } : null;
}

// ‚îÄ‚îÄ AREA RANKING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildAreaGrid(lastPoint) {
  const stops = db?.stops || {};
  const areas = {};
  for (const [id, info] of Object.entries(stops)) {
    if (!areas[info.area]) areas[info.area] = { total:0, onTime:0 };
    const s = (lastPoint.stops||{})[id];
    if (s) { areas[info.area].total+=s.total; areas[info.area].onTime+=s.onTime; }
  }

  // Sort worst ‚Üí best
  const sorted = Object.entries(areas)
    .map(([area,v]) => ({ area, p: pct(v.onTime,v.total), total: v.total }))
    .sort((a,b) => a.p - b.p);

  const allPct = pct(lastPoint.onTime, lastPoint.total);
  const grid = document.getElementById('area-grid');

  grid.innerHTML = `
    <div class="area-rank-list" role="list">
      <div class="area-rank-row active" role="listitem button" tabindex="0"
           data-area="all" aria-pressed="true"
           onclick="setArea('all')" onkeydown="if(event.key==='Enter')setArea('all')">
        <span class="rank-num">‚Äî</span>
        <span class="rank-name" style="font-weight:700;color:#fff">Hele Oslo</span>
        <div class="rank-bg"><div class="rank-fill" style="width:${allPct}%;background:${barColor(allPct)}"></div></div>
        <span class="rank-pct" style="color:${barColor(allPct)}">${allPct}%</span>
      </div>
      ${sorted.map(({area, p}, i) => `
      <div class="area-rank-row" role="listitem button" tabindex="0"
           data-area="${area}" aria-pressed="false"
           onclick="setArea('${area}')" onkeydown="if(event.key==='Enter')setArea('${area}')">
        <span class="rank-num" style="${i===0?'color:var(--red)':i===sorted.length-1?'color:var(--green)':''}">
          ${i===0?'üíÄ':i===sorted.length-1?'üëë':i+1}
        </span>
        <span class="rank-name">${area}</span>
        <div class="rank-bg"><div class="rank-fill" style="width:${p}%;background:${barColor(p)}"></div></div>
        <span class="rank-pct" style="color:${barColor(p)}">${p||'‚Äì'}%</span>
      </div>`).join('')}
    </div>`;
}

function setArea(area) {
  activeArea = area;
  document.querySelectorAll('.area-rank-row, .area-btn').forEach(b => {
    const active = b.dataset.area === area;
    b.classList.toggle('active', active);
    b.setAttribute('aria-pressed', String(active));
  });
  filterMapByArea(area);
  if (db) renderStats();
  if (area !== 'all') document.getElementById('map').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function setMode(mode) {
  activeMode = mode;
  document.querySelectorAll('.mode-btn').forEach(b => {
    const active = b.dataset.mode === mode;
    b.classList.toggle('active', active);
    b.setAttribute('aria-pressed', String(active));
  });
  if (db) renderStats();
}

// ‚îÄ‚îÄ MAIN RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function render() {
  if (!db || !db.history.length) return;
  const last  = db.history[db.history.length-1];
  const stops = db.stops || {};

  // Rush hour badge
  const rushEl = document.getElementById('rush-badge');
  const rushLabelEl = document.getElementById('rush-label');
  if (rushEl) {
    const rush = isRushHour();
    rushEl.classList.toggle('visible', rush);
    if (rush && rushLabelEl) rushLabelEl.textContent = rushLabel().replace('üö® ','');
  }

  buildAreaGrid(last);
  updateMap(last, stops);
  filterMapByArea(activeArea);
  renderStats();
}

// Keep rush badge in sync every minute even without data refresh
setInterval(() => {
  const el = document.getElementById('rush-badge');
  const lb = document.getElementById('rush-label');
  if (el) { el.classList.toggle('visible', isRushHour()); if (lb) lb.textContent = rushLabel().replace('üö® ',''); }
}, 60000);

function renderStats() {
  const history = db.history;
  const now24 = Date.now()/1000 - 86400;
  const now48 = Date.now()/1000 - 172800;
  const last   = history[history.length-1];
  const recent = history.filter(h=>h.t>=now24);
  const chart  = history.filter(h=>h.t>=now48);

  // Aggregate
  const t24 = recent.reduce((a,h) => {
    const s = slicePoint(h, activeMode, activeArea);
    if (!s) return a;
    a.total+=s.total; a.onTime+=s.onTime; a.delayed+=s.delayed; a.cancelled+=s.cancelled;
    return a;
  }, {total:0,onTime:0,delayed:0,cancelled:0});

  const lastSlice = slicePoint(last, activeMode, activeArea) || {total:0,onTime:0,delayed:0,cancelled:0};
  const avg24 = pct(t24.onTime, t24.total);
  const nowPct = pct(lastSlice.onTime, lastSlice.total);
  const [,verdict,cls] = VERDICTS.find(([t])=>avg24>=t);

  // Trend
  const trend = calcTrend(history, activeMode, activeArea);
  const trendEl = document.getElementById('trend-line');
  if (trendEl) {
    trendEl.innerHTML = trend
      ? `<span class="trend ${trend.dir}" title="Siste 30 min vs 30‚Äì90 min siden">${trend.html}</span>
         <span style="font-size:.72rem;color:var(--muted);margin-left:.4rem">siste time</span>`
      : '';
  }

  // Score bar
  document.getElementById('big-num').textContent = avg24+'%';
  document.getElementById('big-num').className = `big-num ${cls}`;
  document.getElementById('verdict').textContent = verdict;
  const modeStr = activeMode!=='all' ? `${MODE_ICON[activeMode]||''} Kun ${MODES_NO[activeMode]||activeMode} ¬∑ ` : '';
  const areaStr = activeArea!=='all' ? `üìç ${activeArea} ¬∑ ` : '';
  document.getElementById('score-desc').innerHTML =
    `${modeStr}${areaStr}<strong>${t24.total.toLocaleString('no-NO')}</strong> avganger siste 24t ¬∑ <strong>${t24.delayed}</strong> forsinket ¬∑ <strong>${t24.cancelled}</strong> innstilt`;

  // Mode aggregation for bars
  const modeAgg = {};
  for (const h of recent) {
    for (const [m,v] of Object.entries(h.modes||{})) {
      if (!modeAgg[m]) modeAgg[m]={total:0,onTime:0,delayed:0};
      modeAgg[m].total+=v.total; modeAgg[m].onTime+=v.onTime; modeAgg[m].delayed+=(v.delayed||0);
    }
  }
  const modesSorted = Object.entries(modeAgg).filter(([,v])=>v.total>5).sort((a,b)=>b[1].total-a[1].total);

  // By hour
  const byHour={};
  for (const h of recent) {
    const s=slicePoint(h,activeMode,activeArea);
    if(!s||!s.total) continue;
    const hr=hourOf(h.t);
    if(!byHour[hr])byHour[hr]={on:0,tot:0};
    byHour[hr].on+=s.onTime; byHour[hr].tot+=s.total;
  }
  const hrs = Object.entries(byHour).filter(([,v])=>v.tot>0);
  const worstHour = hrs.slice().sort((a,b)=>pct(a[1].on,a[1].tot)-pct(b[1].on,b[1].tot))[0];
  const bestHour  = hrs.slice().sort((a,b)=>pct(b[1].on,b[1].tot)-pct(a[1].on,a[1].tot))[0];
  const worstMode = modesSorted.slice().sort((a,b)=>pct(a[1].onTime,a[1].total)-pct(b[1].onTime,b[1].total))[0];
  const bestMode  = modesSorted.slice().sort((a,b)=>pct(b[1].onTime,b[1].total)-pct(a[1].onTime,a[1].total))[0];
  const worstSamp = [...recent].filter(h=>{const s=slicePoint(h,activeMode,activeArea);return s&&s.total>0;})
    .sort((a,b)=>pct(slicePoint(a,activeMode,activeArea).onTime,slicePoint(a,activeMode,activeArea).total)-pct(slicePoint(b,activeMode,activeArea).onTime,slicePoint(b,activeMode,activeArea).total))[0];
  const worstSampSlice = worstSamp?slicePoint(worstSamp,activeMode,activeArea):null;
  const todayStr = dateStr();
  const todaySamples = history.filter(h => dateStr(new Date(h.t * 1000)) === todayStr).length;

  // Line rankings ‚Äî aggregate across last 24h, min 8 trips to qualify
  const linesAgg = aggregateLines(recent);
  const linesSorted = Object.values(linesAgg)
    .filter(l => l.total >= 8 && (activeMode === 'all' || l.mode === activeMode))
    .sort((a,b) => pct(a.onTime,a.total) - pct(b.onTime,b.total));
  const worstLine = linesSorted[0] || null;
  const bestLine  = linesSorted[linesSorted.length-1] || null;

  // Chart data
  const chartPts = chart.map(h=>({t:h.t,s:slicePoint(h,activeMode,activeArea)})).filter(p=>p.s&&p.s.total>0);

  document.getElementById('stats').innerHTML = `
    <div class="stat-row">
      <div class="stat ${nowPct>=80?'green':nowPct>=65?'amber':'red'}">
        <p class="val">${nowPct}%</p><p class="lbl">I rute n√•</p><p class="sub">${lastSlice.onTime} av ${lastSlice.total}</p>
      </div>
      <div class="stat amber">
        <p class="val">${pct(lastSlice.delayed,lastSlice.total)}%</p><p class="lbl">Forsinket n√•</p><p class="sub">${lastSlice.delayed} av ${lastSlice.total}</p>
      </div>
      <div class="stat red">
        <p class="val">${lastSlice.cancelled>0?pct(lastSlice.cancelled,lastSlice.total)+'%':'0%'}</p><p class="lbl">Innstilt</p><p class="sub">${lastSlice.cancelled} av ${lastSlice.total}</p>
      </div>
    </div>

    <div class="card">
      <h2>Punktlighet ‚Äî siste 48 timer</h2>
      <div class="chart-wrap"><canvas id="chart" role="img" aria-label="Linjediagram punktlighet over tid"></canvas></div>
    </div>

    <div class="card">
      <h2>Per transportmiddel ‚Äî 24t snitt</h2>
      <div class="mode-list" role="list">
        ${modesSorted.map(([m,v])=>{const p=pct(v.onTime,v.total);return `
        <div class="mode-row" role="listitem">
          <span class="mode-icon" aria-hidden="true">${MODE_ICON[m]||'üöê'}</span>
          <span class="mode-name">${MODES_NO[m]||m}</span>
          <div class="mode-bg" role="progressbar" aria-valuenow="${p}" aria-valuemin="0" aria-valuemax="100" aria-label="${MODES_NO[m]||m}: ${p}% i rute">
            <div class="mode-fill" style="width:${p}%;background:${barColor(p)}"></div>
          </div>
          <span class="mode-pct" style="color:${barColor(p)}">${p}%</span>
          <span class="mode-cnt">${v.total.toLocaleString('no-NO')} avg.</span>
        </div>`}).join('')||'<p style="color:var(--muted);font-size:.85rem">Mangler data‚Ä¶</p>'}
      </div>
    </div>

    <div class="card">
      <h2>Statistikk &amp; Skamtavle</h2>
      <div class="shame-grid">
        ${worstHour?`<div class="shame-item"><p class="shame-lbl">Verste time i dag</p><p class="shame-val">${String(worstHour[0]).padStart(2,'0')}:00 ‚Äî ${pct(worstHour[1].on,worstHour[1].tot)}%</p><p class="shame-sub">i rute den timen</p></div>`:''}
        ${bestHour?`<div class="shame-item"><p class="shame-lbl">Beste time i dag</p><p class="shame-val">${String(bestHour[0]).padStart(2,'0')}:00 ‚Äî ${pct(bestHour[1].on,bestHour[1].tot)}%</p><p class="shame-sub">i rute den timen</p></div>`:''}
        ${worstMode?`<div class="shame-item"><p class="shame-lbl">Verste transportmiddel</p><p class="shame-val">${MODE_ICON[worstMode[0]]||''} ${MODES_NO[worstMode[0]]||worstMode[0]}</p><p class="shame-sub">${pct(worstMode[1].onTime,worstMode[1].total)}% i rute</p></div>`:''}
        ${bestMode?`<div class="shame-item"><p class="shame-lbl">Mest p√•litelig</p><p class="shame-val">${MODE_ICON[bestMode[0]]||''} ${MODES_NO[bestMode[0]]||bestMode[0]}</p><p class="shame-sub">${pct(bestMode[1].onTime,bestMode[1].total)}% i rute üëè</p></div>`:''}
        ${worstLine?`<div class="shame-item"><p class="shame-lbl">üíÄ Verste linje (24t)</p><p class="shame-val">${MODE_ICON[worstLine.mode]||'üöê'} Linje ${worstLine.name}</p><p class="shame-sub">${pct(worstLine.onTime,worstLine.total)}% i rute ¬∑ ${worstLine.delayed} forsinkelser</p></div>`:''}
        ${bestLine?`<div class="shame-item"><p class="shame-lbl">üëë Beste linje (24t)</p><p class="shame-val">${MODE_ICON[bestLine.mode]||'üöê'} Linje ${bestLine.name}</p><p class="shame-sub">${pct(bestLine.onTime,bestLine.total)}% i rute ¬∑ ${bestLine.total} avganger</p></div>`:''}
        ${worstSamp&&worstSampSlice?`<div class="shame-item"><p class="shame-lbl">Verste enkeltm√•ling</p><p class="shame-val">${pct(worstSampSlice.onTime,worstSampSlice.total)}% kl. ${fmtTime(worstSamp.t)}</p><p class="shame-sub">${worstSampSlice.delayed} forsinket, ${worstSampSlice.cancelled} innstilt</p></div>`:''}
        <div class="shame-item"><p class="shame-lbl">Datapunkter i dag</p><p class="shame-val">${todaySamples} m√•linger</p><p class="shame-sub">av ~${Math.round(86400/900)} mulige</p></div>
      </div>
    </div>

    <p class="footer">
      Sist oppdatert: ${new Date(db.updated).toLocaleString('no-NO')} ¬∑
      ${history.length} m√•linger lagret ¬∑
      <a href="https://github.com/PiE-Derby/oslo-on-time" target="_blank" rel="noopener">kildekode</a>
    </p>
  `;

  // Draw / update chart
  if (chartObj) { chartObj.destroy(); chartObj = null; }
  const canvas = document.getElementById('chart');
  if (canvas && chartPts.length) {
    chartObj = new Chart(canvas, {
      type: 'line',
      data: {
        labels: chartPts.map(p=>fmtTime(p.t)),
        datasets: [{
          data: chartPts.map(p=>pct(p.s.onTime,p.s.total)),
          borderColor:'#0cb6eb',
          backgroundColor: ctx=>{const g=ctx.chart.ctx.createLinearGradient(0,0,0,150);g.addColorStop(0,'rgba(12,182,235,.15)');g.addColorStop(1,'rgba(12,182,235,0)');return g;},
          borderWidth:1.5, fill:true, tension:0.4, pointRadius:0, pointHoverRadius:4, pointHoverBackgroundColor:'#0cb6eb',
        }]
      },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins:{
          legend:{display:false},
          tooltip:{backgroundColor:'#1a1d25',borderColor:'rgba(255,255,255,.08)',borderWidth:1,titleColor:'#8090a8',bodyColor:'#fff',padding:10,callbacks:{label:ctx=>`${ctx.parsed.y}% i rute`}}
        },
        scales:{
          x:{ticks:{maxTicksLimit:7,font:{size:10},color:'#8090a8'},grid:{display:false},border:{display:false}},
          y:{min:0,max:100,ticks:{callback:v=>v+'%',font:{size:10},color:'#8090a8',maxTicksLimit:5},grid:{color:'rgba(255,255,255,.04)'},border:{display:false}}
        }
      }
    });
  }
}

// ‚îÄ‚îÄ REFRESH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function dateStr(d = new Date()) {
  return new Intl.DateTimeFormat('sv-SE', {
    timeZone: 'Europe/Oslo', year: 'numeric', month: '2-digit', day: '2-digit'
  }).format(d);
}

async function load() {
  try {
    const bust = '?t=' + Date.now();

    // 1. Latest snapshot + stop metadata (tiny, fast)
    const latestRes = await fetch('data/latest.json' + bust);
    if (!latestRes.ok) throw new Error('latest.json not found');
    const latest = await latestRes.json();

    // 2. Today's history
    const today = dateStr();
    let history = [];
    try {
      const todayRes = await fetch(`data/${today}.json` + bust);
      if (todayRes.ok) history = await todayRes.json();
    } catch(e) {}

    // 3. Yesterday's history (for 48h chart), best-effort
    const yesterday = dateStr(new Date(Date.now() - 86400000));
    if (yesterday !== today) {
      try {
        const yestRes = await fetch(`data/${yesterday}.json`);
        if (yestRes.ok) {
          const yest = await yestRes.json();
          history = [...yest, ...history];
        }
      } catch(e) {}
    }

    // If daily file is empty/missing, fall back to snapshot as only data point
    if (!history.length && latest.snapshot) history = [latest.snapshot];

    db = { stops: latest.stops, updated: latest.updated, history };

    if (db.history?.length) render();
    else document.getElementById('stats').innerHTML =
      '<div style="text-align:center;padding:3rem;color:var(--muted)"><h2 style="font-family:Urbanist,sans-serif;color:#fff">Starter opp‚Ä¶</h2><p style="margin-top:.5rem;font-size:.85rem">F√∏rste data samles inn.</p></div>';
  } catch(e) { console.error(e); }
}

const REFRESH_SEC=60; let countdown=REFRESH_SEC, lastUpdated=null, paused=false, refreshTimer=null;
function updateBadge(){
  const label=document.getElementById('refresh-label'), badge=document.getElementById('refresh-badge');
  if(!label||!badge)return;
  if(paused){
    badge.classList.add('paused'); badge.setAttribute('aria-pressed','true');
    const ago=lastUpdated?Math.round((Date.now()-lastUpdated)/1000):0;
    label.textContent=`Pauset ¬∑ ${ago<60?ago+'s':Math.round(ago/60)+'m'} siden`;
  } else {
    badge.classList.remove('paused'); badge.setAttribute('aria-pressed','false');
    if(countdown<=0) label.textContent='Oppdaterer‚Ä¶';
    else if(lastUpdated){const ago=Math.round((Date.now()-lastUpdated)/1000);label.textContent=`For ${ago<60?ago+'s':Math.round(ago/60)+'m'} siden ¬∑ om ${countdown}s`;}
    else label.textContent=`Om ${countdown}s`;
  }
}
function togglePause(){
  paused=!paused;
  if(paused){clearInterval(refreshTimer);refreshTimer=null;}
  else{countdown=REFRESH_SEC;scheduleRefresh();}
  updateBadge();
}
async function doRefresh(){if(paused)return;countdown=0;updateBadge();await load();lastUpdated=Date.now();countdown=REFRESH_SEC;}
function scheduleRefresh(){refreshTimer=setInterval(doRefresh,REFRESH_SEC*1000);}
setInterval(()=>{if(!paused)countdown=Math.max(0,countdown-1);updateBadge();},1000);

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
initMap();
scheduleRefresh();
load().then(()=>{lastUpdated=Date.now();updateBadge();});
</script>
</body>
</html>
