<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Oslo Transit ‚Äî On Time?</title>
  <meta name="description" content="Is Oslo public transport running on schedule? Real stats updated every 15 minutes.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@600;700;800&family=Inter:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg:     #111318;
      --bg2:    #1a1d25;
      --bg3:    #20242e;
      --border: rgba(255,255,255,0.07);
      --text:   #f0f2f5;
      --muted:  #6b7280;
      --cyan:   #0cb6eb;
      --green:  #22c55e;
      --amber:  #f59e0b;
      --red:    #ef4444;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }
    body::before {
      content: '';
      position: fixed; inset: 0; z-index: 0;
      background-image:
        linear-gradient(rgba(12,182,235,0.025) 1px, transparent 1px),
        linear-gradient(90deg, rgba(12,182,235,0.025) 1px, transparent 1px);
      background-size: 44px 44px;
      pointer-events: none;
    }

    /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
    .page { position: relative; z-index: 1; max-width: 760px; margin: 0 auto; padding: 2.5rem 1.25rem 4rem; }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    .header {
      display: flex; align-items: flex-start; justify-content: space-between;
      gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;
    }
    .header h1 {
      font-family: 'Urbanist', sans-serif;
      font-size: 1.5rem; font-weight: 800;
      letter-spacing: -0.03em; color: #fff;
    }
    .header h1 span { color: var(--cyan); }
    .header p { font-size: 0.8rem; color: var(--muted); margin-top: 0.25rem; }
    .live-badge {
      display: flex; align-items: center; gap: 0.4rem;
      font-size: 0.72rem; font-weight: 500; color: var(--green);
      background: rgba(34,197,94,0.08);
      border: 1px solid rgba(34,197,94,0.2);
      padding: 0.3rem 0.7rem; border-radius: 999px;
      white-space: nowrap;
    }
    .live-badge .dot { width: 6px; height: 6px; background: var(--green); border-radius: 50%; animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

    /* ‚îÄ‚îÄ HERO SCORE ‚îÄ‚îÄ */
    .hero-score {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 1rem;
      display: flex; align-items: center; gap: 2rem;
      position: relative; overflow: hidden;
    }
    .hero-score::before {
      content: '';
      position: absolute; top: 0; left: 0; right: 0; height: 2px;
      background: linear-gradient(90deg, transparent, var(--cyan), transparent);
    }
    .big-num {
      font-family: 'Urbanist', sans-serif;
      font-size: 5.5rem;
      font-weight: 800;
      letter-spacing: -0.05em;
      line-height: 1;
      transition: color 0.4s;
    }
    .big-num.good   { color: var(--green); }
    .big-num.ok     { color: var(--amber); }
    .big-num.bad    { color: var(--red); }
    .score-meta { flex: 1; }
    .verdict {
      font-family: 'Urbanist', sans-serif;
      font-size: 1.3rem; font-weight: 700;
      color: #fff; letter-spacing: -0.02em;
    }
    .score-desc { font-size: 0.82rem; color: var(--muted); margin-top: 0.35rem; line-height: 1.6; }
    .score-desc strong { color: #c9d4e0; }

    /* ‚îÄ‚îÄ STAT GRID ‚îÄ‚îÄ */
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .stat {
      background: var(--bg2); border: 1px solid var(--border);
      border-radius: 12px; padding: 1rem 1.1rem;
      text-align: center;
    }
    .stat .val {
      font-family: 'Urbanist', sans-serif;
      font-size: 2rem; font-weight: 800;
      letter-spacing: -0.04em; line-height: 1;
    }
    .stat .lbl { font-size: 0.7rem; color: var(--muted); margin-top: 0.25rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; }
    .stat .sub { font-size: 0.7rem; color: var(--muted); margin-top: 0.2rem; opacity: 0.6; }
    .stat.green .val { color: var(--green); }
    .stat.amber .val { color: var(--amber); }
    .stat.red   .val { color: var(--red); }

    /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
    .card {
      background: var(--bg2); border: 1px solid var(--border);
      border-radius: 12px; padding: 1.25rem 1.5rem;
      margin-bottom: 1rem;
    }
    .card-title {
      font-size: 0.68rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.1em;
      color: var(--muted); margin-bottom: 1.1rem;
    }

    /* Chart */
    .chart-wrap { position: relative; height: 160px; }

    /* Mode bars */
    .mode-list { display: flex; flex-direction: column; gap: 0.9rem; }
    .mode-row  { display: flex; align-items: center; gap: 0.9rem; }
    .mode-icon { font-size: 1rem; width: 22px; text-align: center; flex-shrink: 0; }
    .mode-name { font-size: 0.85rem; font-weight: 500; width: 72px; flex-shrink: 0; }
    .mode-bar-bg { flex: 1; height: 6px; background: rgba(255,255,255,0.06); border-radius: 3px; overflow: hidden; }
    .mode-bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s; }
    .mode-pct { font-size: 0.82rem; font-weight: 600; width: 38px; text-align: right; }
    .mode-count { font-size: 0.72rem; color: var(--muted); width: 60px; text-align: right; }

    /* Shame stats */
    .shame-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }
    .shame-item {
      background: var(--bg3); border: 1px solid var(--border);
      border-radius: 10px; padding: 0.9rem 1rem;
    }
    .shame-label { font-size: 0.68rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.06em; font-weight: 500; }
    .shame-value { font-family: 'Urbanist', sans-serif; font-size: 1.2rem; font-weight: 700; color: #fff; margin-top: 0.25rem; }
    .shame-sub   { font-size: 0.72rem; color: var(--muted); margin-top: 0.1rem; }

    /* Footer */
    .footer { text-align: center; margin-top: 2rem; font-size: 0.72rem; color: var(--muted); opacity: 0.4; }

    /* No data */
    .no-data { text-align: center; padding: 5rem 1rem; color: var(--muted); }
    .no-data h2 { font-family: 'Urbanist', sans-serif; font-size: 1.5rem; font-weight: 700; color: #fff; margin-bottom: 0.5rem; }
    .no-data p  { font-size: 0.85rem; line-height: 1.7; }

    @media (max-width: 500px) {
      .hero-score { flex-direction: column; gap: 0.75rem; }
      .big-num { font-size: 4rem; }
      .stat-grid { grid-template-columns: repeat(3, 1fr); }
      .shame-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<div class="page">

  <div class="header">
    <div>
      <h1>Oslo Transit ‚Äî <span>On Time?</span></h1>
      <p>Sampled from 5 major hubs via Entur ¬∑ Updated every 15 min</p>
    </div>
    <div class="live-badge"><div class="dot"></div> Live</div>
  </div>

  <div id="app"><div class="no-data"><h2>Collecting data‚Ä¶</h2><p>First samples are being gathered.<br>Check back in a few minutes.</p></div></div>

</div>

<script>
const MODES = {
  rail:    { label: 'Train',  icon: 'üöÜ' },
  metro:   { label: 'T-bane', icon: 'üöá' },
  tram:    { label: 'Tram',   icon: 'üöä' },
  bus:     { label: 'Bus',    icon: 'üöå' },
  water:   { label: 'Ferry',  icon: '‚õ¥Ô∏è' },
  unknown: { label: 'Other',  icon: 'üöê' },
};
const VERDICTS = [
  [90, 'Running smooth üü¢',   'good'],
  [78, 'Mostly on time',       'ok'],
  [65, 'Some delays today',    'ok'],
  [50, 'Pretty rough out there üî¥', 'bad'],
  [0,  'Total chaos üö®',       'bad'],
];

function pct(v, t) { return t > 0 ? Math.round(v / t * 100) : 0; }

function barColor(p) {
  if (p >= 80) return '#22c55e';
  if (p >= 60) return '#f59e0b';
  return '#ef4444';
}

function fmtTime(ts) {
  return new Date(ts * 1000).toLocaleTimeString('no-NO', { hour: '2-digit', minute: '2-digit' });
}

function fmtDate(ts) {
  return new Date(ts * 1000).toLocaleDateString('no-NO', { weekday: 'short', hour: '2-digit', minute: '2-digit' });
}

function hourOf(ts) {
  return new Date(ts * 1000).getUTCHours();
}

function render(db) {
  const history = db.history || [];
  if (history.length < 1) return;

  const now24  = Date.now() / 1000 - 86400;
  const now48  = Date.now() / 1000 - 172800;
  const last   = history[history.length - 1];
  const recent = history.filter(h => h.t >= now24);
  const chart  = history.filter(h => h.t >= now48);

  // 24h totals
  const t24 = recent.reduce((a,h) => {
    a.total+=h.total; a.onTime+=h.onTime; a.delayed+=h.delayed; a.cancelled+=h.cancelled;
    return a;
  }, {total:0,onTime:0,delayed:0,cancelled:0});

  const avg24 = pct(t24.onTime, t24.total);
  const nowPct = pct(last.onTime, last.total);
  const [,verdict,cls] = VERDICTS.find(([thresh]) => avg24 >= thresh);

  // Mode aggregation 24h
  const modes = {};
  for (const h of recent) {
    for (const [m, v] of Object.entries(h.modes || {})) {
      if (!modes[m]) modes[m] = {total:0,onTime:0,delayed:0};
      modes[m].total   += v.total;
      modes[m].onTime  += v.onTime;
      modes[m].delayed += (v.delayed||0);
    }
  }
  const modesSorted = Object.entries(modes)
    .filter(([,v]) => v.total > 5)
    .sort((a,b) => b[1].total - a[1].total);

  // Shame stats
  // Worst hour (by avg pct in last 24h)
  const byHour = {};
  for (const h of recent) {
    const hr = hourOf(h.t);
    if (!byHour[hr]) byHour[hr] = {on:0,tot:0};
    byHour[hr].on  += h.onTime;
    byHour[hr].tot += h.total;
  }
  const hourEntries = Object.entries(byHour).filter(([,v]) => v.tot > 0);
  const worstHour  = hourEntries.sort((a,b) => pct(a[1].on,a[1].tot) - pct(b[1].on,b[1].tot))[0];
  const bestHour   = hourEntries.sort((a,b) => pct(b[1].on,b[1].tot) - pct(a[1].on,a[1].tot))[0];

  // Worst mode
  const worstMode = modesSorted.length ? modesSorted.slice().sort((a,b) => pct(a[1].onTime,a[1].total) - pct(b[1].onTime,b[1].total))[0] : null;
  const bestMode  = modesSorted.length ? modesSorted.slice().sort((a,b) => pct(b[1].onTime,b[1].total) - pct(a[1].onTime,a[1].total))[0] : null;

  // Worst single sample
  const worstSample = [...recent].sort((a,b) => pct(a.onTime,a.total) - pct(b.onTime,b.total))[0];

  // Samples collected today
  const todayStart = new Date(); todayStart.setUTCHours(0,0,0,0);
  const todaySamples = history.filter(h => h.t >= todayStart.getTime()/1000).length;

  const app = document.getElementById('app');
  app.innerHTML = `

    <div class="hero-score">
      <div class="big-num ${cls}">${avg24}%</div>
      <div class="score-meta">
        <div class="verdict">${verdict}</div>
        <div class="score-desc">
          <strong>${t24.total.toLocaleString()}</strong> departures sampled over 24h<br>
          <strong>${t24.delayed}</strong> delayed ¬∑ <strong>${t24.cancelled}</strong> cancelled ¬∑ <strong>${t24.onTime}</strong> on time
        </div>
      </div>
    </div>

    <div class="stat-grid">
      <div class="stat ${nowPct>=80?'green':nowPct>=65?'amber':'red'}">
        <div class="val">${nowPct}%</div>
        <div class="lbl">On time now</div>
        <div class="sub">${last.onTime} of ${last.total}</div>
      </div>
      <div class="stat amber">
        <div class="val">${pct(last.delayed, last.total)}%</div>
        <div class="lbl">Delayed now</div>
        <div class="sub">${last.delayed} of ${last.total}</div>
      </div>
      <div class="stat red">
        <div class="val">${last.cancelled > 0 ? pct(last.cancelled, last.total)+'%' : '0%'}</div>
        <div class="lbl">Cancelled</div>
        <div class="sub">${last.cancelled} of ${last.total}</div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Punctuality ‚Äî last 48 hours</div>
      <div class="chart-wrap"><canvas id="chart"></canvas></div>
    </div>

    <div class="card">
      <div class="card-title">By mode ‚Äî 24h average</div>
      <div class="mode-list">
        ${modesSorted.map(([mode, m]) => {
          const p = pct(m.onTime, m.total);
          const info = MODES[mode] || MODES.unknown;
          return `<div class="mode-row">
            <span class="mode-icon">${info.icon}</span>
            <span class="mode-name">${info.label}</span>
            <div class="mode-bar-bg">
              <div class="mode-bar-fill" style="width:${p}%;background:${barColor(p)}"></div>
            </div>
            <span class="mode-pct" style="color:${barColor(p)}">${p}%</span>
            <span class="mode-count">${m.total.toLocaleString()} trips</span>
          </div>`;
        }).join('') || '<div style="color:var(--muted);font-size:0.85rem">Need more data‚Ä¶</div>'}
      </div>
    </div>

    <div class="card">
      <div class="card-title">Stats & Shame Board</div>
      <div class="shame-grid">
        ${worstHour ? `
        <div class="shame-item">
          <div class="shame-label">Worst Hour Today</div>
          <div class="shame-value">${worstHour[0].padStart(2,'0')}:00 ‚Äî ${pct(worstHour[1].on,worstHour[1].tot)}%</div>
          <div class="shame-sub">on time during that hour</div>
        </div>` : ''}
        ${bestHour ? `
        <div class="shame-item">
          <div class="shame-label">Best Hour Today</div>
          <div class="shame-value">${bestHour[0].padStart(2,'0')}:00 ‚Äî ${pct(bestHour[1].on,bestHour[1].tot)}%</div>
          <div class="shame-sub">on time during that hour</div>
        </div>` : ''}
        ${worstMode ? `
        <div class="shame-item">
          <div class="shame-label">Worst Mode</div>
          <div class="shame-value">${(MODES[worstMode[0]]||MODES.unknown).icon} ${(MODES[worstMode[0]]||MODES.unknown).label}</div>
          <div class="shame-sub">${pct(worstMode[1].onTime,worstMode[1].total)}% on time ‚Äî needs improvement</div>
        </div>` : ''}
        ${bestMode ? `
        <div class="shame-item">
          <div class="shame-label">Most Reliable</div>
          <div class="shame-value">${(MODES[bestMode[0]]||MODES.unknown).icon} ${(MODES[bestMode[0]]||MODES.unknown).label}</div>
          <div class="shame-sub">${pct(bestMode[1].onTime,bestMode[1].total)}% on time ‚Äî üëè</div>
        </div>` : ''}
        ${worstSample ? `
        <div class="shame-item">
          <div class="shame-label">Worst Sample (24h)</div>
          <div class="shame-value">${pct(worstSample.onTime,worstSample.total)}% @ ${fmtTime(worstSample.t)}</div>
          <div class="shame-sub">${worstSample.delayed} delayed, ${worstSample.cancelled} cancelled</div>
        </div>` : ''}
        <div class="shame-item">
          <div class="shame-label">Data Points Today</div>
          <div class="shame-value">${todaySamples} samples</div>
          <div class="shame-sub">of ~${Math.round(86400/900)} possible (15 min interval)</div>
        </div>
      </div>
    </div>

    <p class="footer">Last updated: ${new Date(db.updated).toLocaleString('no-NO')} ¬∑ ${history.length} total samples stored ¬∑ <a href="https://github.com/PiE-Derby/oslo-on-time" target="_blank" style="color:var(--muted);text-decoration:none">source</a></p>
  `;

  // Draw chart
  const labels  = chart.map(h => fmtTime(h.t));
  const values  = chart.map(h => pct(h.onTime, h.total));
  new Chart(document.getElementById('chart'), {
    type: 'line',
    data: {
      labels,
      datasets: [{
        data: values,
        borderColor: '#0cb6eb',
        backgroundColor: (ctx) => {
          const g = ctx.chart.ctx.createLinearGradient(0, 0, 0, 160);
          g.addColorStop(0, 'rgba(12,182,235,0.15)');
          g.addColorStop(1, 'rgba(12,182,235,0)');
          return g;
        },
        borderWidth: 1.5,
        fill: true,
        tension: 0.4,
        pointRadius: 0,
        pointHoverRadius: 4,
        pointHoverBackgroundColor: '#0cb6eb',
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#1a1d25',
          borderColor: 'rgba(255,255,255,0.08)',
          borderWidth: 1,
          titleColor: '#a0aab8',
          bodyColor: '#fff',
          padding: 10,
          callbacks: { label: ctx => `${ctx.parsed.y}% on time` }
        }
      },
      scales: {
        x: { ticks: { maxTicksLimit: 7, font:{size:10}, color:'#4b5563' }, grid: { display: false }, border: { display: false } },
        y: { min: 0, max: 100,
             ticks: { callback: v => v+'%', font:{size:10}, color:'#4b5563', maxTicksLimit: 5 },
             grid: { color: 'rgba(255,255,255,0.04)' }, border: { display: false } }
      }
    }
  });
}

async function load() {
  try {
    const r = await fetch('data/stats.json?t=' + Date.now());
    const db = await r.json();
    if ((db.history||[]).length > 0) render(db);
    else document.getElementById('app').innerHTML =
      '<div class="no-data"><h2>Warming up‚Ä¶</h2><p>First samples are being gathered.<br>Cron runs every 15 min ‚Äî check back shortly.</p></div>';
  } catch(e) {
    document.getElementById('app').innerHTML =
      '<div class="no-data"><h2>Can\'t load stats</h2><p>'+e.message+'</p></div>';
  }
}

load();
setInterval(load, 60000); // refresh every 60s
</script>
</body>
</html>
